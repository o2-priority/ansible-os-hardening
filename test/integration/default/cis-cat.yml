---
- name: CIS Configuration Assessment Tool
  hosts: test-kitchen
  become: yes

  vars:
    cis_cat_work_dir: /var/tmp/cis
    cis_cat_results_dir: "{{ cis_cat_work_dir }}/results"
    cis_cat_bundle_archive: ciscat-cutdown-2018-01-18-v3.0.45.zip
    cis_cat_scripts_dir: "{{ cis_cat_work_dir }}/cis-cat-full"
    cis_benchmark_file: CIS_Ubuntu_Linux_16.04_LTS_Benchmark_v1.0.0-xccdf.xml

  pre_tasks:
    - name: Install packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - "unzip"
        - "openjdk-8-jdk"

  tasks:
    - name: START HERE
      debug: msg='starting here'

    - name: Create cis-cat work dirs
      file:
        path: "{{ item }}"
        state: directory
      with_items:
        - "{{ cis_cat_work_dir }}"
        - "{{ cis_cat_results_dir }}"

    - name: Copy and Unarchive cis-cat archive
      unarchive:
        src:  /tmp/kitchen/roles/ansible-os-hardening/test/{{ cis_cat_bundle_archive }}
        dest: "{{ cis_cat_work_dir }}/"
        remote_src: yes

    - name: Run cis-cat scan | level 1
      shell: >
          bash ./CIS-CAT.sh --accept-terms \
              --benchmark benchmarks/{{ cis_benchmark_file }} \
              --profile xccdf_org.cisecurity.benchmarks_profile_Level_1_-_Server \
              --results-dir {{ cis_cat_results_dir }}
      args:
        chdir: "{{ cis_cat_scripts_dir }}"
      register: level_1

    - debug: var=level_1

    - name: Run cis-cat scan | level 2
      shell: >
          bash ./CIS-CAT.sh --accept-terms \
              --benchmark benchmarks/{{ cis_benchmark_file }} \
              --profile xccdf_org.cisecurity.benchmarks_profile_Level_2_-_Server \
              --results-dir {{ cis_cat_results_dir }}
      args:
        chdir: "{{ cis_cat_scripts_dir }}"
      register: level_2

    - debug: var=level_2

    - name: Download cis-cat scan results
      synchronize:
        mode: pull
        src: "{{ cis_cat_results_dir }}/"
        dest: "./results/{{ ansible_host }}"

  post_tasks:
    - name: Remove packages
      apt:
        name: "{{ item }}"
        state: absent
      with_items:
        - "unzip"
        - "openjdk-8-jdk"